<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{
	direction: rtl;
	text-align: center;
	font-family: Arial, sans-serif;
	font-size: 14px;
	color: #000;
	background-color: white !important;
	padding: 40px;
	line-height: 1.2em;
}
a,p, li, h1, h2, h3{
	color: #000;
	line-height: 1.2em;
}
.reg-days{
	width: 90%;
	margin: 10px auto;
	padding: 20px;
	background: #00457b;
	color: white;
}
.error{
	font-weight: bold;
	color: red;
	font-size: 24px;
	line-height: 28px;
}
.success{
	font-weight: bold;
	color: green;
	font-size: 24px;
	line-height: 28px;
}
.attention{
	font-weight: bold;
	color: orange;
	font-size: 24px;
	line-height: 28px;
}
</style>
</head>
<body>

<?php

global $user;

if (!in_array('checkin', array_values($user->roles))) {
	//print "no permission\n";

//	print '<h2><a href="/">תכנס למערכת</a></h2>';
	//print '<h2><a href="/">Please login to the system</a></h2>';
	//break; 
}	

define('CIVI_URL', 'http://neworg.kbb1.com');
// TODO: change this to our site key;
// search for SITE_KEY in sites/defaults/civicrm.settings.php.
define('SITE_KEY', '6d6ccf53722a1cb3a8dcef6780764096');

define('API_KEY', 'oLEAvAw1QXzglFY64T7j4iZg');

// CiviCRM things:
define('STATUS_ATTENDED', 2);

/**
 * Call CiviCRM HTTP API.
 *
 * @param $entity string Name of CiviCRM entity, e.g. Contact, Relationship,...
 * @param $action string 'get' to retrieve, 'create' to create or update
 * @param $params array parameters to be passed to the API
 */
function _civicrm_http_api($entity, $action, $params) {
  // TODO: input validation. $action is the most important to check.
  $url = CIVI_URL . '/sites/all/modules/civicrm/extern/rest.php';
  $curl = curl_init();
  $rest_params = array(
      'key'=> SITE_KEY,
      'api_key' => API_KEY,
      'sequential' => 1,
      'entity' => $entity,
      'action' => $action,
      'json' => json_encode($params),
  );

  
  $opts = array(
      CURLOPT_URL => $url,
      CURLOPT_POST => TRUE,
      CURLOPT_POSTFIELDS => $rest_params,
      CURLOPT_RETURNTRANSFER => TRUE,
      CURLOPT_SSL_VERIFYPEER => FALSE,
  );
  curl_setopt_array($curl, $opts);
  $result = curl_exec($curl);
  $result = strstr($result, '{');
  curl_close($curl);


  
  $result = json_decode($result, true);
  
  //print_r($result);
 
  // You should probably handle HTTP errors here.

  return $result;
}



if (isset($_GET['id'])) {
	
  $participantId = $_GET['id'];
  // avoid script injection.
  //is_numeric($participantId) or die('מספר זיהוי של משתתף לא תקין.');
  is_numeric($participantId) or die('Participant ID is not valid.');

  // TODO: check whether the participant exists. (We are lucky,
  // because the API call will fail if the ID does not exist.)
  
  
  $params = array(
    // update participant with
    'id' => $participantId,
    // change status to 'attended'
    //'status_id' => STATUS_ATTENDED,
    // Use chained call to get contact name
    'api.Contact.getsingle' => array(
      'id' => '$value.contact_id',
      'return' => 'display_name'
    ),
    // Use another chained call to get event title
    'api.Event.getsingle' => array(
      'id' => '$value.event_id',
      'return' => 'title'
    ),
	'api.Activity.get' => array(
		'contact_id' => '$value.contact_id',
		'subject' => '2',
		'activity_type_id' => '5',

		'return' => 'subject,activity_date_time'
		
	)
  );
  
  $result = _civicrm_http_api('Participant', 'get', $params);
  $participant = $result['values'][0];
  $participant_status_id = $participant['participant_status_id'];

  //echo 'סטטוס בדיקה' . $participant_status_id . '<br>';
  
  // If error
  if ($result['is_error']) {
    //print "שגיעה: <br />";
	print "Error: <br />";
    print $result['error_message'] . "<br />";
  }
  
  else if ($result['count'] != 1){
	  
	//  print '<h2  class="error">משתתף לא נמצא במערכת<br>נא לגשת לעמדת בירורים.</h2>';
	print '<h2  class="error">Participant ID was not found.</h2>';
  }
  
  // If status = Registered 
  
  else if ($participant_status_id == 1){	  
	
	//print "משתתף: " . $participant['api.Contact.getsingle']['display_name'] . "<br /><hr>";
	print "Participant: " . $participant['api.Contact.getsingle']['display_name'] . "<br /><hr>";
	
	$params = array(
		// update participant with
		'id' => $participantId,
		// change status to 'attended'
		'status_id' => STATUS_ATTENDED,
		
		// Use chained call to get contact name
		'api.Contact.getsingle' => array(
		  'id' => '$value.contact_id',
		  'return' => 'display_name'
		),
		// Use another chained call to get event title
		'api.Event.getsingle' => array(
		  'id' => '$value.event_id',
		  'return' => 'title'
		),
		'return' => 'custom_441'
		
	);
    
	$result = _civicrm_http_api('Participant', 'create', $params);
	 
	//print_r($result);
	 
	 // If error
	  if ($result['is_error'] || $result['count'] != 1) {
		//print "שגיאה: <br />";
		print "Error: <br />";
		print $result['error_message'] . "<br />";
	  }
	  
	  else {
  
		$participant = $result['values'][0];

		//print '<h2 class="success">משתתף נקלט בהצלחה</h2>';
		print '<h2 class="success">Participant was checked in successfully.</h2>';		
		
		//print "<h2>סוג כרטיס: </h2>" . $participant['custom_441'];
		
		//print '<h2>ימי הכנס:</h2>';
		print '<h2>Convention days:</h2>';
		print '<div class="reg-days">';
		foreach($participant['fee_level'] as $key ) {
			print ($key . "<br />");
		}			  
		print '</div>';
	  }  
  }  

  // If status = Pending from pay later (for US conventions) 
  
  else if ($participant_status_id == 5){	  
	
		//print "שם משתתף: " . $participant['api.Contact.getsingle']['display_name'] . "<br /><hr>";
		print "Participant name: " . $participant['api.Contact.getsingle']['display_name'] . "<br /><hr>";
		
		//echo '<h2 class="error">הרשמה לא הושלמה<br>נא לגשת לעמדת בירורים.</h2>' . '<br>';
		echo '<h2 class="error">Registration is pendding due to incomplete payment. Please contact the registration repesentative to complete the payment.</h2>' . '<br>';
		
		//print "<h2>סטטוס: " . $participant['participant_status'] . "</h2>"; 
		print "<h2>Status: " . $participant['participant_status'] . "</h2>"; 
		
		print "<br />" . $participant['api.Event.getsingle']['title'] . "<br />"; 
  }  

    
  // If status = Attended
  
  else if ($participant_status_id == 2){
    
	//print "שם משתתף: " . $participant['api.Contact.getsingle']['display_name'] . "<br /><hr>";
	print "Participant name: " . $participant['api.Contact.getsingle']['display_name'] . "<br /><hr>";
		
	//print '<h2 class="error">משתתף כבר עבר תהליך קבלה</h2><h2>בתאריך: ';
	print '<h2 class="error">Participant got checked in already.</h2><h2>בתאריך: ';
	
	foreach($participant['api.Activity.get']['values'] as $key ) {
		
		if (strpos($key['subject'],'Attended') > -1  && strpos($key['subject'],'2017') > -1)
			print_r ($key['activity_date_time'] . "<br>");
	}	

   print '</h2>';
	
	print '<div class="reg-days">';
	//print '<h2 style="color: white">ימי הכנס:</h2>';
	print '<h2 style="color: white">Convention days:</h2>';
	
	foreach($participant['participant_fee_level'] as $key ) {
		print ($key . "<br />");
	}			  
	print '</div>';
		
	print "<br />" . $participant['api.Event.getsingle']['title'] . "<br />";
	 
  } 
   // If status not payed
   else if ($participant_status_id > 2 && $participant_status_id != 5){
	  
		//print "שם משתתף: " . $participant['api.Contact.getsingle']['display_name'] . "<br /><hr>";
		print "Participant name: " . $participant['api.Contact.getsingle']['display_name'] . "<br /><hr>";
		
		//echo '<h2 class="error">הרשמה לא הושלמה<br>נא לגשת לעמדת בירורים.</h2>' . '<br>';
		echo '<h2 class="error">Registration was not completed.</h2>' . '<br>';
		
		//print "<h2>סטטוס: " . $participant['participant_status'] . "</h2>"; 
		print "<h2>Status: " . $participant['participant_status'] . "</h2>"; 
		
		print "<br />" . $participant['api.Event.getsingle']['title'] . "<br />";
		
  }
  
  else {
	  //print "<h2>תקלה נא לפנות לאחראי</h2>";
	  print "<h2>An error occured, please contact a registration manager</h2>";
  }
} 

?>

<div class="result">
</div>
<body>